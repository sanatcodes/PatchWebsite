---
interface Props {
    seed?: number;
    cellSize?: number;
    opacity?: number;
    color?: string;
    animate?: boolean;
    animationDuration?: number;
    maskDirection?: 'top' | 'bottom' | 'both' | 'none';
    class?: string;
}

const {
    seed = 42,
    cellSize = 12,
    opacity = 0.04,
    color = 'var(--color-blue-200)',
    animate = true,
    animationDuration = 60,
    maskDirection = 'none',
    class: className
} = Astro.props;

// Simple seeded random number generator (LCG)
function seedRandom(seed: number) {
    let s = seed;
    return () => {
        s = (s * 1103515245 + 12345) & 0x7fffffff;
        return s / 0x7fffffff;
    };
}

// Generate jittered line positions
function generateLines(count: number, baseSeed: number, isVertical: boolean) {
    const lines: Array<{ pos: number; jitter: number }> = [];
    const random = seedRandom(baseSeed);

    for (let i = 1; i < count; i++) {
        const basePos = i * cellSize;
        // Jitter: 0.3-0.8px offset (subtle imperfection)
        const jitter = (random() - 0.5) * 0.8;
        lines.push({ pos: basePos + jitter, jitter });
    }

    return lines;
}

// Calculate number of lines based on a reasonable viewport size
// Cap at 150 lines per axis for performance
const maxLines = 150;
const verticalLines = generateLines(maxLines, seed, true);
const horizontalLines = generateLines(maxLines, seed + 1000, false);

// Determine mask gradient based on direction
let maskGradient = 'none';
if (maskDirection === 'top') {
    maskGradient = 'linear-gradient(to bottom, transparent, black 30%)';
} else if (maskDirection === 'bottom') {
    maskGradient = 'linear-gradient(to top, transparent, black 30%)';
} else if (maskDirection === 'both') {
    maskGradient = 'linear-gradient(to bottom, transparent, black 20%, black 80%, transparent)';
}
---

<div
    class:list={['jittered-grid', { animated: animate }, className]}
    style={`--grid-opacity: ${opacity}; --grid-color: ${color}; --animation-duration: ${animationDuration}s; --mask-gradient: ${maskGradient};`}
    aria-hidden="true"
    data-seed={seed}
>
    <svg
        class="grid-svg"
        width="100%"
        height="100%"
        preserveAspectRatio="none"
    >
        <g class="grid-verticals">
            {verticalLines.map(({ pos }) => (
                <line
                    x1={pos}
                    y1="0"
                    x2={pos}
                    y2="100%"
                    stroke={color}
                    stroke-width="1"
                />
            ))}
        </g>
        <g class="grid-horizontals">
            {horizontalLines.map(({ pos }) => (
                <line
                    x1="0"
                    y1={pos}
                    x2="100%"
                    y2={pos}
                    stroke={color}
                    stroke-width="1"
                />
            ))}
        </g>
    </svg>
</div>

<style>
    .jittered-grid {
        position: absolute;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
        z-index: 0;
        opacity: var(--grid-opacity, 0.04);
    }

    .jittered-grid[style*="--mask-gradient: linear-gradient"] {
        -webkit-mask-image: var(--mask-gradient);
        mask-image: var(--mask-gradient);
    }

    .grid-svg {
        width: 100%;
        height: 100%;
    }

    /* Subtle drift animation */
    .jittered-grid.animated .grid-svg {
        animation: grid-drift var(--animation-duration, 60s) ease-in-out infinite;
    }

    @keyframes grid-drift {
        0%, 100% {
            transform: translate(0, 0);
        }
        25% {
            transform: translate(0.3px, 0.2px);
        }
        50% {
            transform: translate(-0.2px, 0.3px);
        }
        75% {
            transform: translate(0.1px, -0.2px);
        }
    }

    /* Respect reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
        .jittered-grid.animated .grid-svg {
            animation: none;
        }
    }

    /* Mobile: disable animation, reduce opacity */
    @media (max-width: 768px) {
        .jittered-grid.animated .grid-svg {
            animation: none;
        }

        .jittered-grid {
            opacity: 0.02;
        }
    }

    /* Small mobile: hide completely, rely on CSS fallback */
    @media (max-width: 480px) {
        .jittered-grid {
            display: none;
        }
    }
</style>
